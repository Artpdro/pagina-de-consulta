<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta REPIS</title>
  <style>
    :root{
      --blue:#215D98;
      --light:#ffffff;
      --muted:#666;
      --accent:#215D98;
      --card-bg:#ffffff;
      --max-width:1100px;
    }
    *{box-sizing:border-box;font-family: "Segoe UI", Roboto, Arial, sans-serif}
    body{margin:0;background:#f6f6f6;color:#111}

    .app{min-height:100vh;display:flex;align-items:stretch}
    .sidebar{
      width:220px;background:var(--blue);color:var(--light);padding:28px 16px;display:flex;
      flex-direction:column;gap:18px;align-items:flex-start;
    }
    .logo img{width:160px; display:block;}
    .nav-btn{display:inline-block;padding:8px 12px;background:transparent;color:var(--light);
      border:2px solid rgba(255,255,255,0.15);border-radius:6px;text-decoration:none;font-size:14px;}
    .nav-btn:hover{background:rgba(255,255,255,0.06)}

    .main{flex:1;padding:32px 56px;background:linear-gradient(0deg, rgba(255,255,255,0.0), rgba(255,255,255,1));}
    .top-right{display:flex;justify-content:flex-end;margin-bottom:8px;}
    .voltar{ text-decoration:none;color:var(--blue);font-weight:700;border:2px solid var(--blue);
      padding:8px 18px;border-radius:6px;background:#fff;}

    .card{background:var(--card-bg);max-width:var(--max-width);margin-top:14px;padding:36px 48px;
      border-radius:6px;box-shadow:0 6px 18px rgba(20,20,20,0.06);}

    h1{margin:6px 0 22px 0;font-size:30px;font-weight:600;color:#111}

    .loading{text-align:center;padding:40px;color:var(--muted);font-size:16px;}

    form .row{display:flex;gap:18px;align-items:center;margin-bottom:18px;flex-wrap:wrap}
    label{min-width:140px;font-size:14px;color:var(--muted)}
    input[type="text"], input[type="date"]{
      flex:1 1 420px;padding:10px 12px;border:1px solid #cfcfcf;border-radius:6px;font-size:14px;
    }
    .help{font-size:13px;color:#888;margin-top:6px}
    .error{color:#b00020;font-size:13px;margin-left:140px}

    .actions{display:flex;gap:12px;margin-top:8px}
    button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn-send{ background:var(--accent); color:white;}

    .result{
      margin-top:24px;padding:20px;border-radius:8px;font-size:16px;font-weight:600;
      text-align:center;
    }
    .result.success{
      background:#e8f5e8;color:#4CAF50;border:2px solid #4CAF50;
    }
    .result.error{
      background:#ffeaea;color:#f44336;border:2px solid #f44336;
    }
    .result.info{
      background:#e3f2fd;color:var(--blue);border:2px solid var(--blue);
    }

    @media (max-width:800px){
      .sidebar{ display:none; }
      .main{ padding:18px; }
      label{ min-width:110px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">
        <img src="sindnorte.svg" alt="Sindnorte">
      </div>

      <a class="nav-btn" href="abertura.html">Solicitação de abertura</a>
      <a class="nav-btn" href="consulta_repis.html">Consulta REPIS</a>
    </aside>

    <main class="main">
      <div class="top-right">
        <a class="voltar" href="index.html">VOLTAR</a>
      </div>

      <div class="card">
        <h1>Consulta REPIS</h1>

        <div id="loading" class="loading">Carregando banco de dados...</div>

        <div id="consulta" style="display:none;">
          <form id="formConsulta" onsubmit="return false;">
            <div class="row">
              <label for="cnpj">CNPJ</label>
              <input id="cnpj" type="text" inputmode="numeric" placeholder="00.000.000/0000-00" maxlength="18" />
            </div>
            <div id="cnpjError" class="error" style="display:none">CNPJ inválido</div>
            <div class="help" style="margin-left:140px">Digite o CNPJ para verificar se possui REPIS cadastrado.</div>

            <div class="actions">
              <button class="btn-send" id="btnConsultar" type="button">Consultar REPIS</button>
            </div>
          </form>

          <div id="resultado" style="display:none;"></div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script>
    let db = null;

    // máscara/formatador CNPJ (enquanto digita)
    const cnpjInput = document.getElementById('cnpj');
    cnpjInput.addEventListener('input', (e) => {
      const value = e.target.value.replace(/\D/g,'').slice(0,14);
      let formatted = value;
      if(value.length > 12){
        formatted = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2}).*/, '$1.$2.$3/$4-$5');
      } else if(value.length > 8){
        formatted = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{0,4}).*/, '$1.$2.$3/$4');
      } else if(value.length > 5){
        formatted = value.replace(/^(\d{2})(\d{3})(\d{0,3}).*/, '$1.$2.$3');
      } else if(value.length > 2){
        formatted = value.replace(/^(\d{2})(\d{0,3}).*/, '$1.$2');
      }
      e.target.value = formatted;
      toggleCNPJError(!validateCNPJ(value));
    });

    function toggleCNPJError(show){
      const el = document.getElementById('cnpjError');
      el.style.display = show ? 'block' : 'none';
    }

    // validação CNPJ (algoritmo)
    function validateCNPJ(cnpj) {
      if(!cnpj) return false;
      const s = cnpj.replace(/\D/g,'');
      if (s.length !== 14) return false;
      if (/^(\d)\1{13}$/.test(s)) return false;

      const calc = (t) => {
        let sum = 0;
        let pos = t - 7;
        for (let i = t; i >= 1; i--) {
          sum += parseInt(s[t - i]) * pos--;
          if (pos < 2) pos = 9;
        }
        const res = sum % 11;
        return (res < 2) ? 0 : 11 - res;
      }

      const dig1 = calc(12);
      if (dig1 !== parseInt(s[12])) return false;
      const dig2 = calc(13);
      if (dig2 !== parseInt(s[13])) return false;
      return true;
    }

    // Inicializa o SQL.js e carrega o banco de dados
    async function initDatabase() {
      try {
        // Inicializa o SQL.js
        const SQL = await initSqlJs({
          locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        });

        // Carrega o arquivo do banco de dados
        const response = await fetch('repis.db');
        const arrayBuffer = await response.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);
        
        // Cria a instância do banco de dados
        db = new SQL.Database(uint8Array);
        
        // Esconde o loading e mostra a interface de consulta
        document.getElementById('loading').style.display = 'none';
        document.getElementById('consulta').style.display = 'block';
        
        console.log('Banco de dados carregado com sucesso!');
      } catch (error) {
        console.error('Erro ao carregar banco de dados:', error);
        document.getElementById('loading').innerHTML = 'Erro ao carregar banco de dados: ' + error.message;
      }
    }

    function consultarREPIS() {
      if (!db) {
        showResult('Banco de dados não carregado ainda. Aguarde...', 'error');
        return;
      }

      const rawCnpj = document.getElementById('cnpj').value.replace(/\D/g,'');

      if (!validateCNPJ(rawCnpj)) {
        toggleCNPJError(true);
        showResult('CNPJ inválido. Verifique antes de consultar.', 'error');
        return;
      }

      const formattedCnpj = rawCnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");

      try {
        // Consulta SQL para verificar se o CNPJ existe
        const stmt = db.prepare(`
          SELECT COUNT(*) as count 
          FROM repis 
          WHERE cnpj = ?
        `);
        
        stmt.bind([formattedCnpj]);
        const result = stmt.step();
        const row = stmt.getAsObject();
        stmt.free();

        if (row.count > 0) {
          showResult(`CNPJ ${formattedCnpj} POSSUI REPIS cadastrado.`, 'success');
        } else {
          showResult(`CNPJ ${formattedCnpj} NÃO POSSUI REPIS cadastrado.`, 'info');
        }
      } catch (error) {
        console.error('Erro na consulta:', error);
        showResult('Erro ao realizar consulta: ' + error.message, 'error');
      }
    }

    function showResult(message, type) {
      const resultadoDiv = document.getElementById('resultado');
      resultadoDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
      resultadoDiv.style.display = 'block';
    }

    // Event listeners
    document.getElementById('btnConsultar').addEventListener('click', consultarREPIS);

    // Permite buscar pressionando Enter
    document.getElementById('cnpj').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        consultarREPIS();
      }
    });

    // Inicializa o banco de dados quando a página carrega
    initDatabase();
  </script>
</body>
</html>

